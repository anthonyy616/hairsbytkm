<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Hairs By TKM</title>
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-amber-50">
    <!-- Navigation -->
    <nav class="bg-amber-800 text-white sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <i data-feather="cake" class="text-amber-300"></i>
                <h1 class="text-xl font-bold">Hairs By TKM</h1>
            </div>
            <div class="flex items-center space-x-4">
                <a href="login.html" class="bg-amber-600 hover:bg-amber-700 px-4 py-2 rounded-full transition">Login</a>
                <a href="signup.html" class="hover:text-amber-300 transition">Sign Up</a>
            </div>
        </div>
    </nav>

    <!-- Login Form -->
    <section class="py-16 min-h-screen flex items-center justify-center">
        <div class="bg-white rounded-xl shadow-lg p-8 max-w-md w-full" data-aos="fade-up">
            <h2 class="text-3xl font-bold text-center mb-8 text-amber-800">Welcome Back</h2>
            
            <form id="login-form" class="space-y-6">
                <div>
                    <label for="login_id" class="block text-sm font-medium text-gray-700 mb-2">Email Address</label>
                    <input type="text" id="login_id" required 
                           placeholder="Enter your email"
                           class="w-full px-4 py-2 border border-amber-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500">
                </div>
                
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                    <input type="password" id="password" required 
                           class="w-full px-4 py-2 border border-amber-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500">
                </div>
                
                <div class="flex items-center justify-between">
                    <label class="flex items-center">
                        <input type="checkbox" id="remember-me" class="rounded border-amber-300 text-amber-600 focus:ring-amber-500">
                        <span class="ml-2 text-sm text-gray-600">Remember me</span>
                    </label>
                    
                    <a href="#" id="forgot-password-link" class="text-sm text-amber-600 hover:text-amber-700">
                        Forgot password?
                    </a>
                </div>
                
                <button type="submit" 
                        class="w-full bg-amber-600 hover:bg-amber-700 text-white py-3 rounded-lg transition transform hover:scale-[1.02]">
                    Login
                </button>
            </form>

            <!-- Forgot Password Form -->
            <div id="forgot-password-form" class="hidden space-y-6">
                <h3 class="text-xl font-bold text-center text-amber-800">Reset Password</h3>
                <p class="text-sm text-gray-600 text-center">Enter your email address and we'll send you a password reset link.</p>
                
                <div>
                    <label for="reset-email" class="block text-sm font-medium text-gray-700 mb-2">Email Address</label>
                    <input type="email" id="reset-email" required 
                           class="w-full px-4 py-2 border border-amber-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500">
                </div>
                
                <button id="reset-password" 
                        class="w-full bg-amber-600 hover:bg-amber-700 text-white py-3 rounded-lg transition">
                    Send Reset Link
                </button>
                
                <div class="text-center">
                    <a href="#" id="back-to-login" class="text-sm text-amber-600 hover:text-amber-700">
                        ‚Üê Back to Login
                    </a>
                </div>
            </div>
            
            <div class="mt-6 text-center">
                <p class="text-gray-600">Don't have an account? 
                    <a href="signup.html" class="text-amber-600 hover:text-amber-700 font-medium">Sign up here</a>
                </p>
            </div>
            
            <div id="status" class="mt-4 p-3 rounded-lg text-center hidden"></div>
        </div>
    </section>

    <script>
        // Initialize Feather Icons
        feather.replace();

        // Initialize AOS
        if (typeof AOS !== 'undefined') {
            AOS.init({ duration: 800, easing: 'ease-in-out' });
        }

        // Supabase Configuration - USE YOUR ACTUAL CREDENTIALS
        const supabaseUrl = 'https://nkmxznymrpvgzlznprmu.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5rbXh6bnltcnB2Z3psem5wcm11Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5MDkyMTcsImV4cCI6MjA3NTQ4NTIxN30.5ZUz6WaFL-GTr72PXuCvG-4Xq_rplKZ_E0y3iI2HLmQ';
        
        // Initialize Supabase client correctly
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey, {
            auth: {
                persistSession: true,
                autoRefreshToken: true,
                detectSessionInUrl: true
            }
        });

        // Login function
        async function loginUser(event) {
            event.preventDefault();
            
            const login_id = document.getElementById('login_id').value.trim();
            const password = document.getElementById('password').value;
            const rememberMe = document.getElementById('remember-me').checked;
            const statusDiv = document.getElementById('status');

            // Show loading state
            const submitBtn = event.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Logging in...';
            submitBtn.disabled = true;

            try {
                // Sign in with email/password (Supabase doesn't support phone login directly)
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: login_id, // Only email login supported in signInWithPassword
                    password: password
                });

                if (error) {
                    throw new Error(error.message);
                }

                if (data.user) {
                    // Fetch user profile
                    const { data: profile, error: profileError } = await supabase
                        .from('profiles')
                        .select('*')
                        .eq('id', data.user.id)
                        .single();

                    // Store profile locally (even if there's an error fetching it)
                    if (!profileError && profile) {
                        localStorage.setItem('userProfile', JSON.stringify(profile));
                    }

                    // Store session preference
                    if (rememberMe) {
                        localStorage.setItem('rememberMe', 'true');
                    }

                    // Show success message
                    statusDiv.className = 'mt-4 p-3 rounded-lg text-center bg-green-100 text-green-700';
                    statusDiv.innerHTML = '<strong>Success!</strong> Logged in successfully. Redirecting...';
                    statusDiv.classList.remove('hidden');

                    // Redirect after success
                    setTimeout(() => {
                        window.location.href = 'homepage.html';
                    }, 1000);
                }

            } catch (error) {
                statusDiv.className = 'mt-4 p-3 rounded-lg text-center bg-red-100 text-red-700';
                statusDiv.textContent = `Error: ${error.message}`;
                statusDiv.classList.remove('hidden');
            } finally {
                // Reset button state
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        }

        // Password reset function
        async function resetPassword(event) {
            event.preventDefault();
            
            const resetEmail = document.getElementById('reset-email').value.trim();
            const statusDiv = document.getElementById('status');
            const resetBtn = document.getElementById('reset-password');

            // Show loading state
            const originalText = resetBtn.textContent;
            resetBtn.textContent = 'Sending...';
            resetBtn.disabled = true;

            try {
                const { error } = await supabase.auth.resetPasswordForEmail(resetEmail, {
                    redirectTo: `${window.location.origin}/reset-password.html`
                });

                if (error) {
                    throw new Error(error.message);
                }

                statusDiv.className = 'mt-4 p-3 rounded-lg text-center bg-green-100 text-green-700';
                statusDiv.textContent = 'Password reset link sent to your email!';
                statusDiv.classList.remove('hidden');

                // Switch back to login form after 3 seconds
                setTimeout(() => {
                    showLoginForm();
                }, 3000);

            } catch (error) {
                statusDiv.className = 'mt-4 p-3 rounded-lg text-center bg-red-100 text-red-700';
                statusDiv.textContent = `Error: ${error.message}`;
                statusDiv.classList.remove('hidden');
            } finally {
                resetBtn.textContent = originalText;
                resetBtn.disabled = false;
            }
        }

        // Form visibility functions
        function showForgotPasswordForm() {
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('forgot-password-form').classList.remove('hidden');
            document.getElementById('status').classList.add('hidden');
        }

        function showLoginForm() {
            document.getElementById('forgot-password-form').classList.add('hidden');
            document.getElementById('login-form').classList.remove('hidden');
            document.getElementById('status').classList.add('hidden');
        }

        // Event listeners
        document.getElementById('login-form').addEventListener('submit', loginUser);
        document.getElementById('forgot-password-link').addEventListener('click', (e) => {
            e.preventDefault();
            showForgotPasswordForm();
        });
        document.getElementById('back-to-login').addEventListener('click', (e) => {
            e.preventDefault();
            showLoginForm();
        });
        document.getElementById('reset-password').addEventListener('click', resetPassword);

        // Check if user is already logged in
        supabase.auth.getSession().then(({ data: { session } }) => {
            if (session) {
                window.location.href = 'homepage.html';
            }
        });

        // Auth state listener
        supabase.auth.onAuthStateChange((event, session) => {
            if (event === 'SIGNED_IN' && session) {
                console.log('User signed in:', session.user.email);
            } else if (event === 'SIGNED_OUT') {
                console.log('User signed out');
                localStorage.removeItem('userProfile');
            }
        });
    </script>
    <script src="auth.js" defer></script>
</body>
</html>